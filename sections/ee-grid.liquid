<section id="ee-grid-{{ section.id }}" class="ee-grid">
  <div class="ee-grid__head">
    <h2 class="ee-grid__title">{{ section.settings.heading }}</h2>
  </div>

  <div class="ee-grid__wrap">
    {% for i in (1..6) %}
      {% assign key = 'product_' | append: i %}
      {% assign chosen = section.settings[key] %}
      {% if chosen != blank %}
        <article
          class="ee-card"
          data-handle="{{ chosen.handle }}"
          data-product-id="{{ chosen.id }}"
        >
          <button class="ee-card__open" aria-label="Open {{ chosen.title }} quick view">+</button>
          <div class="ee-card__img">
            {% if chosen.featured_image %}
              {{
                chosen.featured_image
                | image_url: width: 720
                | image_tag: alt: chosen.title, loading: 'lazy'
              }}
            {% endif %}
          </div>
        </article>
      {% endif %}
    {% endfor %}
  </div>

  <!-- JSON payload -->
  <script type="application/json" id="ee-grid-data-{{ section.id }}">
    {
      "products":[
        {% assign first = true %}
        {% for i in (1..6) %}
          {% assign key = 'product_' | append: i %}
          {% assign p = section.settings[key] %}
          {% if p %}
            {% unless first %},{% endunless %}
            {
              "id": {{ p.id | json }},
              "handle": {{ p.handle | json }},
              "title": {{ p.title | json }},
              "price": {{ p.price | json }},
              "price_formatted": {{ p.price | money | strip_newlines | json }},
              "description": {{ p.description | strip_html | truncate: 240 | json }},
              "featured_image": {{ p.featured_image | image_url: width: 600 | json }},
              "options": {{ p.options_with_values | json }},
              "variants": [
                {% for v in p.variants %}
                  {
                    "id": {{ v.id | json }},
                    "title": {{ v.title | json }},
                    "available": {{ v.available | json }},
                    "price": {{ v.price | json }},
                    "options": {{ v.options | json }}
                  }{% unless forloop.last %},{% endunless %}
                {% endfor %}
              ]
            }
            {% assign first = false %}
          {% endif %}
        {% endfor %}
      ],
      "autoAdd": {
        {% if section.settings.bonus_product %}
          "title": {{ section.settings.bonus_product.title | json }},
          "variant_id": {{ section.settings.bonus_product.selected_or_first_available_variant.id | json }}
        {% else %}
          "title": null,
          "variant_id": null
        {% endif %}
      }
    }
  </script>

  <!-- Modal -->
  <div class="ee-modal" aria-hidden="true">
    <div class="ee-modal__backdrop"></div>
    <div class="ee-modal__dialog" role="dialog" aria-modal="true">
      <button class="ee-modal__close" aria-label="Close">×</button>

      <div class="ee-modal__media">
        <img class="ee-modal__img" alt="" loading="lazy">
      </div>

      <div class="ee-modal__body">
        <h3 class="ee-modal__title"></h3>
        <div class="ee-modal__price"></div>
        <p class="ee-modal__desc"></p>

        <form class="ee-form" novalidate>
          <div class="ee-form__opts"></div>

          <div class="ee-form__size">
            <label class="ee-label">Size</label>
            <div class="ee-select">
              <select name="size"></select>
              <span class="ee-select__icon">▾</span>
            </div>
          </div>

          <button type="submit" class="ee-btn ee-btn--add">
            <span>ADD TO CART</span>
            <span class="ee-arrow">→</span>
          </button>
          <p class="ee-form__msg" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  #ee-grid-{{ section.id }}{ --gap:18px; --black:#111; --accent:#FCEB00; }
  .ee-grid__wrap{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap);}
  @media(max-width:990px){ .ee-grid__wrap{grid-template-columns:repeat(2,1fr);} }
  @media(max-width:640px){ .ee-grid__wrap{grid-template-columns:1fr;} }

  .ee-card{ position:relative; overflow:hidden; border-radius:6px;}
  .ee-card__open{position:absolute; right:10px; top:10px; width:32px; height:32px; border-radius:50%; background:#fff; border:1px solid #d9d9d9; cursor:pointer;}

  /* Modal Centered */
  .ee-modal{ position:fixed; inset:0; display:none; z-index:100; justify-content:center; align-items:center; }
  .ee-modal[aria-hidden="false"]{ display:flex; }
  .ee-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); animation:fadeIn .3s; }
  .ee-modal__dialog{ background:#fff; width:380px; padding:18px; border-radius:6px; position:relative; z-index:2; animation:fadeIn .35s ease; }
  .ee-modal__close{ position:absolute; right:12px; top:8px; background:none; border:none; font-size:22px; cursor:pointer; }

  .ee-modal__media img{ width:100%; height:200px; object-fit:cover; border:1px solid #eee; }
  .ee-modal__title{ font-size:18px; margin:8px 0 4px; }
  .ee-modal__price{ font-weight:700; margin-bottom:8px; }
  .ee-modal__desc{ font-size:14px; color:#444; margin-bottom:12px; }

  /* Options column */
  .ee-form__opts{ display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
  .ee-pill{ border:1px solid #ccc; padding:10px; cursor:pointer; background:#fff; text-align:center; }
  .ee-pill[aria-pressed="true"]{ background:#000; color:#fff; border-color:#000; }

  /* Size dropdown */
  .ee-select{ position:relative; display:block; margin-bottom:12px; }
  .ee-select select{ width:100%; padding:10px 36px 10px 12px; border:1px solid #ccc; cursor:pointer; background:#fff; transition:all .3s;}
  .ee-select__icon{ position:absolute; right:10px; top:50%; transform:translateY(-50%); transition:transform .3s; }
  .ee-select select:focus + .ee-select__icon{ transform:translateY(-50%) rotate(180deg); }
  @keyframes fadeIn{from{opacity:0;} to{opacity:1;}}

  /* Add to cart button */
  .ee-btn{ display:inline-flex; justify-content:center; align-items:center; gap:.5rem; width:100%; padding:.9rem 1.2rem; background:#000; color:#fff; border:none; cursor:pointer;}
  .ee-btn:hover{ background:var(--accent); color:#000; }
</style>

<script>
(() => {
  const root=document.getElementById('ee-grid-{{ section.id }}');
  if(!root) return;
  const data=JSON.parse(document.getElementById('ee-grid-data-{{ section.id }}').textContent);
  const modal=root.querySelector('.ee-modal');
  const imgEl=modal.querySelector('.ee-modal__img');
  const titleEl=modal.querySelector('.ee-modal__title');
  const priceEl=modal.querySelector('.ee-modal__price');
  const descEl=modal.querySelector('.ee-modal__desc');
  const optsEl=modal.querySelector('.ee-form__opts');
  const sizeSel=modal.querySelector('select[name="size"]');
  const form=modal.querySelector('.ee-form');
  const msgEl=modal.querySelector('.ee-form__msg');

  let activeProduct=null,chosen={};

  const open=()=>{modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';};
  const close=()=>{modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; msgEl.textContent='';};
  modal.querySelector('.ee-modal__close').onclick=close;
  modal.querySelector('.ee-modal__backdrop').onclick=close;

  root.querySelectorAll('.ee-card__open').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const handle=btn.closest('.ee-card').dataset.handle;
      const product=data.products.find(p=>p.handle===handle);
      if(!product) return;
      activeProduct=product; chosen={};
      imgEl.src=product.featured_image; titleEl.textContent=product.title;
      priceEl.textContent=product.price_formatted; descEl.textContent=product.description;
      optsEl.innerHTML='';
      product.options.slice(0,1).forEach(opt=>{
        const wrap=document.createElement('div');
        wrap.innerHTML=`<label class="ee-label">${opt.name}</label>`;
        opt.values.forEach(val=>{
          const pill=document.createElement('button');
          pill.type='button'; pill.className='ee-pill'; pill.textContent=val;
          pill.setAttribute('aria-pressed','false');
          pill.onclick=()=>{wrap.querySelectorAll('.ee-pill').forEach(p=>p.setAttribute('aria-pressed','false')); pill.setAttribute('aria-pressed','true'); chosen[opt.name]=val;};
          wrap.appendChild(pill);
        });
        optsEl.appendChild(wrap);
      });
      sizeSel.innerHTML='<option value="">Choose your size</option>'+[...new Set(product.variants.map(v=>v.options[1]))].map(s=>`<option>${s}</option>`).join('');
      open();
    });
  });

  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const variant=activeProduct.variants.find(v=>activeProduct.options.every((opt,i)=>!chosen[opt.name]||v.options[i]===chosen[opt.name]));
    if(!variant){ msgEl.textContent='Please select options'; return; }
    await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:variant.id,quantity:1})});
    msgEl.textContent='Added to cart ✔'; setTimeout(close,700);
  });
})();
</script>

{% schema %}
{
  "name": "EE • Product Grid",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Tisso vison in the wild" },
    { "type": "product", "id": "product_1", "label": "Product #1" },
    { "type": "product", "id": "product_2", "label": "Product #2" },
    { "type": "product", "id": "product_3", "label": "Product #3" },
    { "type": "product", "id": "product_4", "label": "Product #4" },
    { "type": "product", "id": "product_5", "label": "Product #5" },
    { "type": "product", "id": "product_6", "label": "Product #6" },
    { "type": "header", "content": "Bonus auto-add rule" },
    { "type": "product", "id": "bonus_product", "label": "Soft Winter Jacket" }
  ],
  "presets": [{ "name": "EE • Product Grid" }]
}
{% endschema %}
